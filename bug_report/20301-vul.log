INFO: Seed: 2201185808
INFO: Loaded 1 modules   (117002 inline 8-bit counters): 117002 [0x96a77e0, 0x96c40ea), 
INFO: Loaded 1 PC tables (117002 PCs): 117002 [0x96c40ec,0x97a893c), 
/out/php-fuzz-mbstring: Running 1 inputs 1 time(s) each.
Running: /tmp/poc
=================================================================
==13==ERROR: AddressSanitizer: heap-use-after-free on address 0xe9d37640 at pc 0x08da674d bp 0xffba04a8 sp 0xffba04a0
READ of size 4 at 0xe9d37640 thread T0
SCARINESS: 45 (4-byte-read-heap-use-after-free)
    #0 0x8da674c in optimize_nodes /src/php-src/oniguruma/src/regcomp.c:6263:11
    #1 0x8da5baa in optimize_nodes /src/php-src/oniguruma/src/regcomp.c
    #2 0x8da5455 in optimize_nodes /src/php-src/oniguruma/src/regcomp.c:6271:13
    #3 0x8d95c49 in set_optimize_info_from_tree /src/php-src/oniguruma/src/regcomp.c:6634:7
    #4 0x8d8fca1 in onig_compile /src/php-src/oniguruma/src/regcomp.c:7075:7
    #5 0x8d98554 in onig_new /src/php-src/oniguruma/src/regcomp.c:7255:7
    #6 0x84528f4 in php_mbregex_compile_pattern /src/php-src/ext/mbstring/php_mbregex.c:466:19
    #7 0x844cd3e in _php_mb_regex_ereg_exec /src/php-src/ext/mbstring/php_mbregex.c:929:7
    #8 0x844c8b0 in zif_mb_ereg /src/php-src/ext/mbstring/php_mbregex.c:979:2
    #9 0x8969d8b in zend_call_function /src/php-src/Zend/zend_execute_API.c:778:4
    #10 0x89684b2 in _call_user_function_ex /src/php-src/Zend/zend_execute_API.c:606:9
    #11 0x8d58f18 in fuzzer_call_php_func_zval /src/php-src/sapi/fuzzer/fuzzer-sapi.c:247:2
    #12 0x8d5935a in fuzzer_call_php_func /src/php-src/sapi/fuzzer/fuzzer-sapi.c:267:2
    #13 0x8d57c95 in LLVMFuzzerTestOneInput /src/php-src/sapi/fuzzer/fuzzer-mbstring.c:44:2
    #14 0x80be5b6 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned int) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:556:15
    #15 0x80aaa63 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned int) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:292:6
    #16 0x80b0168 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned int)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:774:9
    #17 0x80d4f77 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:19:10
    #18 0xeb54c646 in __libc_start_main (/lib32/libc.so.6+0x18646)
    #19 0x8085a34 in _start (/out/php-fuzz-mbstring+0x8085a34)

DEDUP_TOKEN: optimize_nodes--optimize_nodes--optimize_nodes
0xe9d37640 is located 0 bytes inside of 56-byte region [0xe9d37640,0xe9d37678)
freed by thread T0 here:
    #0 0x8184957 in free /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:123:3
    #1 0x8d5d913 in node_free_body /src/php-src/oniguruma/src/regparse.c:2074:7
    #2 0x8d5d75a in onig_node_free /src/php-src/oniguruma/src/regparse.c:2129:3
    #3 0x8d5d8b6 in node_free_body /src/php-src/oniguruma/src/regparse.c:2070:5
    #4 0x8d5d75a in onig_node_free /src/php-src/oniguruma/src/regparse.c:2129:3
    #5 0x8d5da96 in node_free_body /src/php-src/oniguruma/src/regparse.c
    #6 0x8d5eac0 in node_reset_str /src/php-src/oniguruma/src/regparse.c:3294:3
    #7 0x8da2343 in tune_look_behind /src/php-src/oniguruma/src/regcomp.c:4504:13
    #8 0x8d9439e in tune_tree /src/php-src/oniguruma/src/regcomp.c:5633:9
    #9 0x8d941a0 in tune_tree /src/php-src/oniguruma/src/regcomp.c:5527:13
    #10 0x8d8f95d in onig_compile /src/php-src/oniguruma/src/regcomp.c:7035:7
    #11 0x8d98554 in onig_new /src/php-src/oniguruma/src/regcomp.c:7255:7
    #12 0x84528f4 in php_mbregex_compile_pattern /src/php-src/ext/mbstring/php_mbregex.c:466:19
    #13 0x844cd3e in _php_mb_regex_ereg_exec /src/php-src/ext/mbstring/php_mbregex.c:929:7
    #14 0x844c8b0 in zif_mb_ereg /src/php-src/ext/mbstring/php_mbregex.c:979:2
    #15 0x8969d8b in zend_call_function /src/php-src/Zend/zend_execute_API.c:778:4
    #16 0x89684b2 in _call_user_function_ex /src/php-src/Zend/zend_execute_API.c:606:9
    #17 0x8d58f18 in fuzzer_call_php_func_zval /src/php-src/sapi/fuzzer/fuzzer-sapi.c:247:2
    #18 0x8d5935a in fuzzer_call_php_func /src/php-src/sapi/fuzzer/fuzzer-sapi.c:267:2
    #19 0x8d57c95 in LLVMFuzzerTestOneInput /src/php-src/sapi/fuzzer/fuzzer-mbstring.c:44:2
    #20 0x80be5b6 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned int) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:556:15
    #21 0x80aaa63 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned int) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:292:6
    #22 0x80b0168 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned int)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:774:9
    #23 0x80d4f77 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:19:10
    #24 0xeb54c646 in __libc_start_main (/lib32/libc.so.6+0x18646)

DEDUP_TOKEN: free--node_free_body--onig_node_free
previously allocated by thread T0 here:
    #0 0x8184bd5 in malloc /src/llvm-project/compiler-rt/lib/asan/asan_malloc_linux.cpp:145:3
    #1 0x8d5dc51 in node_new /src/php-src/oniguruma/src/regparse.c:2146:18
    #2 0x8d5de82 in node_new_bag /src/php-src/oniguruma/src/regparse.c:2465:16
    #3 0x8d7f263 in node_new_memory /src/php-src/oniguruma/src/regparse.c:2518:16
    #4 0x8d72d70 in parse_bag /src/php-src/oniguruma/src/regparse.c:7714:11
    #5 0x8d7003c in parse_exp /src/php-src/oniguruma/src/regparse.c:8039:9
    #6 0x8d6fa41 in parse_branch /src/php-src/oniguruma/src/regparse.c:8440:11
    #7 0x8d6a47b in parse_alts /src/php-src/oniguruma/src/regparse.c:8475:7
    #8 0x8d72e66 in parse_bag /src/php-src/oniguruma/src/regparse.c:7724:7
    #9 0x8d7003c in parse_exp /src/php-src/oniguruma/src/regparse.c:8039:9
    #10 0x8d6f87f in parse_branch /src/php-src/oniguruma/src/regparse.c:8422:7
    #11 0x8d6a47b in parse_alts /src/php-src/oniguruma/src/regparse.c:8475:7
    #12 0x8d614dd in parse_regexp /src/php-src/oniguruma/src/regparse.c:8535:7
    #13 0x8d60e21 in onig_parse_tree /src/php-src/oniguruma/src/regparse.c:8590:7
    #14 0x8d8f4f8 in onig_compile /src/php-src/oniguruma/src/regcomp.c:6987:7
    #15 0x8d98554 in onig_new /src/php-src/oniguruma/src/regcomp.c:7255:7
    #16 0x84528f4 in php_mbregex_compile_pattern /src/php-src/ext/mbstring/php_mbregex.c:466:19
    #17 0x844cd3e in _php_mb_regex_ereg_exec /src/php-src/ext/mbstring/php_mbregex.c:929:7
    #18 0x844c8b0 in zif_mb_ereg /src/php-src/ext/mbstring/php_mbregex.c:979:2
    #19 0x8969d8b in zend_call_function /src/php-src/Zend/zend_execute_API.c:778:4
    #20 0x89684b2 in _call_user_function_ex /src/php-src/Zend/zend_execute_API.c:606:9
    #21 0x8d58f18 in fuzzer_call_php_func_zval /src/php-src/sapi/fuzzer/fuzzer-sapi.c:247:2
    #22 0x8d5935a in fuzzer_call_php_func /src/php-src/sapi/fuzzer/fuzzer-sapi.c:267:2
    #23 0x8d57c95 in LLVMFuzzerTestOneInput /src/php-src/sapi/fuzzer/fuzzer-mbstring.c:44:2
    #24 0x80be5b6 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned int) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:556:15
    #25 0x80aaa63 in fuzzer::RunOneTest(fuzzer::Fuzzer*, char const*, unsigned int) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:292:6
    #26 0x80b0168 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned int)) /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:774:9
    #27 0x80d4f77 in main /src/llvm-project/compiler-rt/lib/fuzzer/FuzzerMain.cpp:19:10
    #28 0xeb54c646 in __libc_start_main (/lib32/libc.so.6+0x18646)

DEDUP_TOKEN: malloc--node_new--node_new_bag
SUMMARY: AddressSanitizer: heap-use-after-free /src/php-src/oniguruma/src/regcomp.c:6263:11 in optimize_nodes
Shadow bytes around the buggy address:
  0x3d3a6e70: fa fa fa fa 00 00 00 00 00 00 00 fa fa fa fa fa
  0x3d3a6e80: 00 00 00 00 00 00 00 fa fa fa fa fa fd fd fd fd
  0x3d3a6e90: fd fd fd fa fa fa fa fa fd fd fd fd fd fd fd fa
  0x3d3a6ea0: fa fa fa fa fd fd fd fd fd fd fd fa fa fa fa fa
  0x3d3a6eb0: fd fd fd fd fd fd fd fa fa fa fa fa fd fd fd fd
=>0x3d3a6ec0: fd fd fd fa fa fa fa fa[fd]fd fd fd fd fd fd fa
  0x3d3a6ed0: fa fa fa fa fd fd fd fd fd fd fd fa fa fa fa fa
  0x3d3a6ee0: fd fd fd fd fd fd fd fa fa fa fa fa fd fd fd fd
  0x3d3a6ef0: fd fd fd fa fa fa fa fa 00 00 00 00 00 00 00 fa
  0x3d3a6f00: fa fa fa fa fd fd fd fd fd fd fd fd fa fa fa fa
  0x3d3a6f10: fd fd fd fd fd fd fd fd fa fa fa fa fd fd fd fd
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==13==ABORTING
